<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="背景上半年参与一个微服务架构Web服务的开发，期间提交了近2W行Java代码，删除近1W行，虽然只是SaaS层的代码，但是还是学到了不少东西，写代码方面学了一些Java基础和编程规范相关的知识，架构方面了解了一些分布式系统相关的概念，另外又抽时间自学了一些中间件、DevOps（主要是怎么使用Docker简化运维）相关的工具。">
<meta property="og:type" content="article">
<meta property="og:title" content="司库云系统简析">
<meta property="og:url" content="https://tallate.github.io/cd87e5dd.html">
<meta property="og:site_name" content="Tallate">
<meta property="og:description" content="背景上半年参与一个微服务架构Web服务的开发，期间提交了近2W行Java代码，删除近1W行，虽然只是SaaS层的代码，但是还是学到了不少东西，写代码方面学了一些Java基础和编程规范相关的知识，架构方面了解了一些分布式系统相关的概念，另外又抽时间自学了一些中间件、DevOps（主要是怎么使用Docker简化运维）相关的工具。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://47.88.24.11/司库云系统简析/契约测试示意图.png">
<meta property="og:updated_time" content="2018-10-16T04:39:39.045Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="司库云系统简析">
<meta name="twitter:description" content="背景上半年参与一个微服务架构Web服务的开发，期间提交了近2W行Java代码，删除近1W行，虽然只是SaaS层的代码，但是还是学到了不少东西，写代码方面学了一些Java基础和编程规范相关的知识，架构方面了解了一些分布式系统相关的概念，另外又抽时间自学了一些中间件、DevOps（主要是怎么使用Docker简化运维）相关的工具。">
<meta name="twitter:image" content="http://47.88.24.11/司库云系统简析/契约测试示意图.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://tallate.github.io/cd87e5dd.html"/>





  <title>司库云系统简析 | Tallate</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Tallate</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tallate.github.io/cd87e5dd.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tallate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tallate">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">司库云系统简析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-12T19:50:53+08:00">
                2018-10-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>上半年参与一个微服务架构Web服务的开发，期间提交了近2W行Java代码，删除近1W行，虽然只是SaaS层的代码，但是还是学到了不少东西，写代码方面学了一些Java基础和编程规范相关的知识，架构方面了解了一些分布式系统相关的概念，另外又抽时间自学了一些中间件、DevOps（主要是怎么使用Docker简化运维）相关的工具。</p>
<a id="more"></a>
<h2 id="业务开发总结"><a href="#业务开发总结" class="headerlink" title="业务开发总结"></a>业务开发总结</h2><p>我所在的部门偏重业务，就我体验来讲，大家对技术并不会钻研太深，项目经理也认为技术员一招一大批，但是找到懂业务的人才却很难，一方面生活中很少人去接触To B的业务，另一方面，项目中用到的业务知识占绝大部分，而技术基本都是由一个平台部门来包装的。<br>项目开发过程中主要涉及到大型企业投融资方面的业务，比如贷款、发债、担保等，因为公司比较看重保密协议，所以我无法在此分享详细的业务相关的内容，只能分享实现过程中的一些想法。</p>
<h3 id="上游功能实现"><a href="#上游功能实现" class="headerlink" title="上游功能实现"></a>上游功能实现</h3><p>司库云中的业务与企业平时填的单据相关，单据之间会有上下游的关系（或者说提供者和消费者），填下游单据前必须填好对应的上游单据（光保存可能还不行，还要先由上级领导审批通过），实际上传统企业都有类似的业务。<br>实现上游功能有一些注意事项：</p>
<ol>
<li>上游需要给下游提供接口，最常见的比如检查上游是否被删除了，因为当下游引用上游到实际保存下游之间会有一段时间，如果在这段时间内上游被删除了，那么这之后再去保存下游就是没有意义的了；</li>
<li>上游有时需要提供一个特殊的接口，名为“参照”，用于列出可以被引用的上游单据，就像输入一些关键词到百度搜索的搜索框中就会弹出一个下拉菜单显示所有相关的搜索项；</li>
<li>删除前必须检查是否已经被下游引用过了，一般来说可以直接由下游提供一个接口来实现这种检查，但是对一些下游特别多、而且会越变越多的单据（指的是用户、银行这些经常被参照到的数据），其实更好的实现方式是将这种耦合转移到数据库中，比如用一个refinfo表来记录所有参照信息（当然也可以直接把删除操作去了…）；</li>
<li>为下游开发人员提供接口及接口文档，这条是容易被忽视的，因为程序员普遍不喜欢读没有注释的代码和给自己的代码加注释；</li>
</ol>
<h3 id="下游功能实现"><a href="#下游功能实现" class="headerlink" title="下游功能实现"></a>下游功能实现</h3><p>实现下游功能似乎会简单一点，但也不尽然：</p>
<ol>
<li>和上游开发沟通接口，最基本的，应该提供所需的返回值格式，而上游则需要说明需要传入哪些参数，另外，这个接口最好是批量的，可以提高效率；</li>
<li>下游开发者需要对RMI远程调用的原理比较熟悉，像调用方法、传参、抛出异常等过程，本质上都是和本地调用不同的。</li>
</ol>
<h3 id="复杂功能实现"><a href="#复杂功能实现" class="headerlink" title="复杂功能实现"></a>复杂功能实现</h3><p>对于一些比较复杂的功能，牵扯到的模块比较多、逻辑比较复杂，做好记录就很重要。写代码最难的不是写代码这个过程，因为只需要基础知识过关、有节操（编码规范），写代码是不难的，难的是写代码前的准备工作，。</p>
<ol>
<li>编码前最好是用软件工程中讲过的建模工具进行建模，最常用的如流程图、时序图等；</li>
<li>就算不想当“画图工程师”、至少也要做好文字记录，最头疼的是见到某些大佬写的1k来行的大方法，还没有多少注释。一些人非常自负，觉得“自己的代码自解释、看不懂纯粹是水平不行”。自解释不知道有没有做到，但加注释绝对是对别人负责的做法，因为不是所有人都有时间去看自己写的代码的，而看注释可以更快地理解自己的想法，不至于迷失在代码细节里。</li>
<li>在用友，其实你不需要懂太多，Java+设计模式+软件工程基础就够了，我在这里学到的最多的应该是软件工程中对风险的控制了：有人懂的话就不要自己瞎想了，有现成的代码就不要自己写了。对于一些复杂的功能，如果之前有人实现过了，那么借鉴一下代码绝对是更划算的做法（还有一个比较阴险的理由是，可以把锅推给人家，所以我觉得抄代码的基本前提是把代码看明白）；</li>
<li>当我们需要写业务代码时，首先要做的第一步应该是和需求进行讨论了，但是很多需求人员其实并不懂代码，他们往往只会从用户的角度对功能进行描述，因此偶尔会碰到沟通困难的情况，这时候可以选择：<ol>
<li>拿流程图和需求进行交流，这样更容易让对方明白自己的脑回路；</li>
<li>催对方把需求写明白一点（容易打起来）；</li>
<li>拜托其他人去和沟通交流。<br>另一方面，如果系统之前已经有类似的功能，首选应该是和相关的开发进行讨论。</li>
</ol>
</li>
</ol>
<h3 id="报表实现"><a href="#报表实现" class="headerlink" title="报表实现"></a>报表实现</h3><p>报表是一种需要从多个表里查数据的功能，根据业务复杂度不同涉及到的表可能达到7、8个，如果想用一个sql把功能写明白，可以想见这样的sql会有多大、多复杂，而且根据编码规范，使用存储过程/函数也是禁止的（因为在云环境下持久层相对业务层更不好扩展）。所以一般是将sql拆成多个，在业务代码中进行联结及分页，刚开始实现时我们将数据库里的数据全部查了出来，然后在内存中进行过滤，对几千条数据进行查询就花了超过10秒，所以后来研究了一些优化的方法，将速度压到了1秒以下：</p>
<ol>
<li>批量查询<br>据说磁盘IO效率（次磁盘访问/秒）和指令执行效率（条指令/秒）之间的比值接近20W:1，因此用更多的指令执行来取代一次磁盘访问一般是值得的。<br>比如需要查某几个班级中的所有同学，我们应该将这些班级的id放到一个in子句内来批量查询，查出来的数据再在代码里借助Map等结构来分出不同班级的同学，因此我们应该写出类似下面的sql和代码：<div><div class="fold_hider"><div class="close hider_title">显示/折叠代码</div></div><div class="fold">
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.id, s.name <span class="keyword">from</span> student s <span class="keyword">where</span> s.class <span class="keyword">in</span> (<span class="string">'c1'</span>, <span class="string">'c2'</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, List&lt;Student&gt;&gt; stuMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;Student&gt;&gt;();</span><br><span class="line"><span class="keyword">for</span>(Student s : students) &#123;  </span><br><span class="line">  List&lt;Student&gt; tmps = stuMap.get(s.getClass());</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">null</span> == tmps) &#123;</span><br><span class="line">    tmps = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    stuMap.put(s.getClass(), tmps);</span><br><span class="line">  &#125;</span><br><span class="line">  tmps.add(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div></li>
<li>“短路”<br>实现内存分页其实没有必要将所有数据都查出来，在查到超过当前页所需要的数据量之后其实就可以直接返回了。</li>
<li>多线程<br>每一行或某几行之间的查询是相互独立的，那么就可以考虑将这些分到多个线程里分别处理。</li>
</ol>
<h3 id="编码风格"><a href="#编码风格" class="headerlink" title="编码风格"></a>编码风格</h3><p>不论是写什么代码，最重要的是风格的统一，所有人最好都使用相同的编码风格，对于容易引起异常的编码方式，可以使用Sonar、FindBugs、阿里编码规范插件等来进行约束，对于一些不规范的编码风格，则只能由自己主动进行交流纠正（大部分人都会因为怕麻烦而懒得帮别人审查，都只遵守自己心里的那套规范，至少我周围是这样）；</p>
<h3 id="自测"><a href="#自测" class="headerlink" title="自测"></a>自测</h3><p>功能开发完毕后，一般不能直接提交到git仓库上，因为很有可能会存在自己没有料到的Bug，所以最好自己先根据功能需求的描述进行自测。当测试提交了一个Bug，为了完整地纠正这个Bug，最好满足以下条件：</p>
<ol>
<li>思考问题原因；</li>
<li>枚举测试没有考虑到的细节；</li>
<li>追究相关场景，因为相同的问题可能在其他类似的功能里出现；</li>
<li>多练练跑步，只要跑得够快，测试就追不上自己。</li>
</ol>
<h2 id="技术总结"><a href="#技术总结" class="headerlink" title="技术总结"></a>技术总结</h2><h3 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h3><ol>
<li>静态工厂方法模式<br>通过静态工厂方法来提供对象实例，一方面方法名比构造器可读性更高，而且多了一层包装后，减少了暴露，更容易修改；<div><div class="fold_hider"><div class="close hider_title">显示/折叠代码</div></div><div class="fold">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RepayIntstAnalyzer <span class="title">getInstance</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RepayIntstAnalyzer <span class="title">getInstance4Extend</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div></li>
<li>策略模式<br>算法很多时候是复杂的，策略模式是针对算法的优化的一种模式，平时若两种算法具有某些代码是重叠的，我们可能直接将它们写在一块，从软件工程的角度来讲，就是代码内聚性低，比如下面的代码将A和B算法的代码合到一个方法内部：<div><div class="fold_hider"><div class="close hider_title">显示/折叠代码</div></div><div class="fold">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doAlgo</span><span class="params">(op)</span> </span>&#123;</span><br><span class="line">    doBefore();</span><br><span class="line">    <span class="keyword">if</span>(op is A) &#123;</span><br><span class="line">        <span class="keyword">do</span> A;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">do</span> B;</span><br><span class="line">    &#125;</span><br><span class="line">    doAfter();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>
为了使得算法的逻辑更加清晰，我们可以将两个算法封装到两个类中，根据用户的输入来传入不同的算法实现类：<div><div class="fold_hider"><div class="close hider_title">显示/折叠代码</div></div><div class="fold">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(srcType == SrcType.REPAY_PRCPL) &#123;</span><br><span class="line">  filter = <span class="keyword">new</span> RefRepayPrcplFilter();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(srcType == SrcType.REPAY_INTST) &#123;</span><br><span class="line">  filter = <span class="keyword">new</span> RefRepayIntstFilter();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(srcType == SrcType.INTST_ADJUST) &#123;</span><br><span class="line">  filter= <span class="keyword">new</span> RefIntAdjFilter();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(srcType == SrcType.LIST) &#123;</span><br><span class="line">  filter = <span class="keyword">new</span> RefListFlter();</span><br><span class="line">&#125;</span><br><span class="line">issueRegisterList = filter.doFilter(issueReigsterList);</span><br></pre></td></tr></table></figure>

</div></div>
使用策略模式可以减少算法之间的耦合，也可以方便后续加入新的算法，当然坏处是在一定程度上会增加代码冗余度。</li>
</ol>
<h3 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h3><p>微服务软件将各模块划分到不同的项目中，互相通过RMI进行调用，好处是能根据需要来部署模块、利于后期进行扩展，坏处是实现起来复杂很多。应用中，用友希望实现自己的云原生环境，开发了一个类似阿里云的应用实例管理平台，可以调配CPU、内存、硬盘等资源，当然还有最基础的应用生命周期、配置、日志管理等功能。对其中的代码我没有研究过（部门之间相互隔离，代码是不能直接看到的），不过这些功能我设想可以基于Docker开放的REST接口来实现，工作量不会小。<br>既然涉及到微服务的基础设施，就不得不提Spring Boot了，Spring Boot是一个应用启动器，它的主要作用是减少手动配置，其核心是约定大于配置的理念，每个模块都具有默认的功能，只要在pom.xml中引入该模块即可使用，除非有特定需求，否则不需要额外的配置。<br>在司库云中，每个业务项目在web.xml配置文件（Spring配置文件）中，注册了一个MwClientLoader类，用于注册所有微服务的基础设施。<br>司库云是我经历的第一个微服务架构项目，我无法很自信地说哪里好哪里坏，但我也感觉到有很多不合理的地方，比如：</p>
<ol>
<li>有现成的就是不用，基于ZooKeeper的分布式锁不用Curator而是自己写了个客户端，结果后期出现低级Bug（比如死锁、释放了别的线程占用的锁等）；</li>
<li>将所有工具类（包括中间件的客户端）都写到一个tmc-utils项目中，供业务模块依赖，虽然方便，但是导致tmc-utils项目颇为臃肿、不稳定，甚至到了后面都没有人知道里面塞了什么东西了；</li>
<li>将所有实现微服务客户端所需的基础设施写到MwClientLoader这个类里来引入，所以司库云其实并没有依赖Spring Boot；</li>
</ol>
<h3 id="RMI远程调用"><a href="#RMI远程调用" class="headerlink" title="RMI远程调用"></a>RMI远程调用</h3><p>RMI是一种将远程调用包装成本地调用形式的技术。在司库云中，即是将接口和参数序列化后通过HTTP协议传过去。在毕设《基于微服务的资金云系统发债管理子系统》中我也有按着这种思路自己实现了一种简单的RMI框架。<br>RMI调用中，框架异常和业务异常默认没有区分，必须得开发自己进行约定，传参只提供对基本类型的转换，如果要传复杂对象，则必须自己将对象属性保存在Map中，然后由接收端取出属性还原对象。<br>服务接口提供者和消费者一般处于独立的两个模块内，这意味着它们会被部署到不同的两个应用实例内，使用RMI的方式来相互调用，就像本地方法调用一样，会有方法名、参数、异常抛出等。当时令我们困扰的是如何区分业务抛出的异常和RMI框架抛出的异常。要知道所有分布式系统都是建立在不稳定的网络条件之上的，超时这种网络异常是家常便饭。对此我们主要有两种方式：</p>
<ol>
<li>使用返回值表示业务异常（接口本身没有返回值的情况下）；<div><div class="fold_hider"><div class="close hider_title">显示/折叠代码</div></div><div class="fold">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// ...业务操作</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"外部放款单出现错误："</span> + e.getMessage();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  <span class="comment">// 释放锁</span></span><br><span class="line">  infinance.setId(infinance.getInfinancepayid());</span><br><span class="line">  <span class="comment">//new VOLockOperaor().unlock(infinance);</span></span><br><span class="line">  infinance.setId(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div></li>
<li>分别定义业务异常和RMI框架异常，分别捕捉。<div><div class="fold_hider"><div class="close hider_title">显示/折叠代码</div></div><div class="fold">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// ...业务操作</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (FrameworkException e) &#123;</span><br><span class="line">  <span class="comment">// ...处理框架抛出异常</span></span><br><span class="line">&#125; <span class="keyword">catch</span>(BusinessException e) &#123;</span><br><span class="line">  <span class="comment">// ...处理业务代码抛出的异常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>
当然，不管是哪种方式，最重要的是接口提供方和调用方开发者的统一。</li>
</ol>
<p>调用方在自测的时候，需要注意接口版本是正确的，有一种情况是，我们并不知道Bug是出在自己的代码里还是RPC接口里，我们本地只有RPC接口的声明，因此普通打断点跟代码的形式就行不通了，我想到的解决办法主要有以下几点：</p>
<pre><code>* 细心编码、滴水不漏，但不是每个人都是Dijkstra；
* 不厌其烦地调试，在发起远程调用的方法处打断点，将请求参数拦截下来，然后另起一个上游模块实例，使用这些数据调用上游接口，再尝试对Bug进行定位；
* 搭建私有化环境，所有关联服务都放到localhost里调试，这种方法必须将几乎所有相关项目的配置文件里的IP都改成localhost，动作比较大，而且这样就和微服务没什么关系了；
* 契约测试，将服务消费者与服务提供者解耦
</code></pre><p><img src="http://47.88.24.11/司库云系统简析/契约测试示意图.png" alt="X" title="契约测试示意图"></p>
<p>RPC远程调用的开销远高于本地调用，过于滥用会对系统性能造成影响，为了避免这个问题，一方面，在设计之初需要由更懂业务的人参与业务模块的划分，减少远程调用；另一方面，可以考虑使用更高效的通信协议、更高效的通信模式（NIO、AIO）和更高效的序列化/反序列化协议，提高RPC协议本身的效率，在分布式系统中，可以说拿下网络协议就是拿下了成功的一半（当然复杂的系统绝不只需要对应用层的考量）。</p>
<p>RPC涉及到多个独立服务实例间的相互调用，会引入数据一致性风险，我在《基于微服务的资金云系统发债管理子系统》这个课题中也做过初步的探究。</p>
<h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><p>司库云中实现了一套基于ZooKeeper的分布式锁，但客户端是自造的轮子，期间也发现了不少问题，比如在测试中曾发生过这么个现象：A修改保存了一条数据，在加锁后后台逻辑出现问题意外退出了，此时锁并没有释放，而B又上来操作了同一条数据，因为锁已经被占用了，因此第一次操作失败了，</p>
<h3 id="事务补偿机制"><a href="#事务补偿机制" class="headerlink" title="事务补偿机制"></a>事务补偿机制</h3>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/7fe149c5.html" rel="next" title="Algorithm-常用算法">
                <i class="fa fa-chevron-left"></i> Algorithm-常用算法
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div id="gitalk-container"></div>

  

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">tallate</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#业务开发总结"><span class="nav-number">2.</span> <span class="nav-text">业务开发总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#上游功能实现"><span class="nav-number">2.1.</span> <span class="nav-text">上游功能实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下游功能实现"><span class="nav-number">2.2.</span> <span class="nav-text">下游功能实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复杂功能实现"><span class="nav-number">2.3.</span> <span class="nav-text">复杂功能实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#报表实现"><span class="nav-number">2.4.</span> <span class="nav-text">报表实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编码风格"><span class="nav-number">2.5.</span> <span class="nav-text">编码风格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自测"><span class="nav-number">2.6.</span> <span class="nav-text">自测</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#技术总结"><span class="nav-number">3.</span> <span class="nav-text">技术总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#设计模式"><span class="nav-number">3.1.</span> <span class="nav-text">设计模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#微服务"><span class="nav-number">3.2.</span> <span class="nav-text">微服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RMI远程调用"><span class="nav-number">3.3.</span> <span class="nav-text">RMI远程调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式锁"><span class="nav-number">3.4.</span> <span class="nav-text">分布式锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事务补偿机制"><span class="nav-number">3.5.</span> <span class="nav-text">事务补偿机制</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tallate</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '72bdd1c9479eb0679788',
          clientSecret: '62c9c0cb45aadb1478ca66cfc3c69c9623f50290',
          repo: 'tallate.github.io',
          owner: 'tallate',
          admin: ['tallate'],
          id: location.pathname,
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')           
       </script>



  





  

  

  
  

  

  

  


  undefined

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"modle":"wanko","pluginModelPath":"assets/","mobile":{"show":false},"display":{"width":150,"height":300},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
