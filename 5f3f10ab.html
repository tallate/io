<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="本地事务,分布式事务,">










<meta name="description" content="这篇文档集中于概念的梳理，不会谈太多实现上的细节。">
<meta name="keywords" content="本地事务,分布式事务">
<meta property="og:type" content="article">
<meta property="og:title" content="分布式事务-从本地事务到分布式事务">
<meta property="og:url" content="https://tallate.github.io/5f3f10ab.html">
<meta property="og:site_name" content="Tallate">
<meta property="og:description" content="这篇文档集中于概念的梳理，不会谈太多实现上的细节。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2021-01-13T01:26:06.217Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="分布式事务-从本地事务到分布式事务">
<meta name="twitter:description" content="这篇文档集中于概念的梳理，不会谈太多实现上的细节。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://tallate.github.io/5f3f10ab.html">







  <title>分布式事务-从本地事务到分布式事务 | Tallate</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Tallate</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">不乱于心，不困于情，不畏将来，不念过往</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>

      <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tallate.github.io/5f3f10ab.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tallate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tallate">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">分布式事务-从本地事务到分布式事务</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-06T10:26:49+08:00">
                2020-12-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式系统/" itemprop="url" rel="index">
                    <span itemprop="name">分布式系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 浏览
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>次
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5.5k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  20 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这篇文档集中于概念的梳理，不会谈太多实现上的细节。</p>
<a id="more"></a>
<h1>单机事务</h1>
<h2 id="acid"><a class="header-anchor" href="#acid">¶</a>ACID</h2>
<ul>
<li>Atomicity	<br>
Atomicity requires that each transaction be “all or nothing”: if one part of the transaction fails, then the entire transaction fails, and the database state is left unchanged. An atomic system must guarantee atomicity in each and every situation, including power failures, errors and crashes. To the outside world, a committed transaction appears (by its effects on the database) to be indivisible (“atomic”), and an aborted transaction does not happen.</li>
<li>Consistency	<br>
The consistency property ensures that any transaction will bring the database from one valid state to another. Any data written to the database must be valid according to all defined rules, including constraints, cascades,triggers, and any combination thereof. This does not guarantee correctness of the transaction in all ways the application programmer might have wanted (that is the responsibility of application-level code), but merely that any programming errors cannot result in the violation of any def ined rules.</li>
<li>Isolation	<br>
The isolation property ensures that the concurrent execution of transactions results in a system state that would be obtained if transactions were executed sequentially, i.e., one after the other. Providing isolation is the main goal of concurrency control. Depending on the concurrency control method (i.e., if it uses strict - as opposed to relaxed - serializability), the effects of an incomplete transaction might not even be visible to another transaction.</li>
<li>Durability	<br>
The durability property ensures that once a transaction has been committed, it will remain so, even in the event of power loss, crashes, or errors. In a relational database, for instance, once a group of SQL statements execute, the results need to be stored permanently (even if the database crashes immediately thereafter). To defend against power loss, transactions (or their effects) must be recorded in a non-volatile memory.</li>
</ul>
<h2 id="三个问题"><a class="header-anchor" href="#三个问题">¶</a>三个问题</h2>
<ol>
<li>脏读<br>
脏读是指在一个事务T1处理过程里读取了另一个 <strong>未提交</strong> 的事务T2中的数据。（注意T2是可能再次修改该条数据甚至回滚的）</li>
<li>不可重复读<br>
不可重复读是指在对于数据库中的某个数据，一个事务T1在多次查询时返回了不同的数据值，这是由于在查询间隔，被另一个事务T2修改并提交了。（注意事务T1包含多次查询操作）</li>
<li>幻读<br>
幻读是指在对数据进行 <strong>批量修改</strong> T1时，由其他事务T2<strong>插入</strong>了一条数据，于是这条数据没有受到修改，这时T1的用户再查询数据库会发现有一条数据没有被修改，就像发生了幻觉。（注意事务T1包含批量写和读这两个过程）</li>
</ol>
<h2 id="事务传播级别-spring"><a class="header-anchor" href="#事务传播级别-spring">¶</a>事务传播级别（Spring）</h2>
<p>传播级别定义的是事务的控制范围：</p>
<ol>
<li>PROPAGATION_REQUIRED ，默认的spring事务传播级别，使用该级别的特点是，如果上下文中已经存在事务，那么就加入到事务中执行，如果当前上下文中不存在事务，则新建事务执行。所以这个级别通常能满足处理大多数的业务场景。</li>
<li>PROPAGATION_SUPPORTS ，从字面意思就知道，supports，支持，该传播级别的特点是，如果上下文存在事务，则支持事务加入事务，如果没有事务，则使用非事务的方式执行。所以说，并非所有的包在transactionTemplate.execute中的代码都会有事务支持。这个通常是用来处理那些并非原子性的非核心业务逻辑操作。应用场景较少。</li>
<li>PROPAGATION_MANDATORY ， 该级别的事务要求上下文中必须要存在事务，否则就会抛出异常！配置该方式的传播级别是有效的控制上下文调用代码遗漏添加事务控制的保证手段。比如一段代码不能单独被调用执行，但是一旦被调用，就必须有事务包含的情况，就可以使用这个传播级别。</li>
<li>PROPAGATION_REQUIRES_NEW ，从字面即可知道，new即每次都要一个新事务，该传播级别的特点是，每次都会新建一个事务，并且同时将上下文中的事务挂起，执行当前新建事务完成以后，上下文事务恢复再执行。<br>
这是一个很有用的传播级别，举一个应用场景：现在有一个发送100个红包的操作，在发送之前，要做一些系统的初始化、验证、数据记录操作，然后发送100封红包，然后再记录发送日志，发送日志要求100%的准确，如果日志不准确，那么整个父事务逻辑需要回滚。<br>
怎么处理整个业务需求呢？就是通过这个PROPAGATION_REQUIRES_NEW 级别的事务传播控制就可以完成。发送红包的子事务不会直接影响到父事务的提交和回滚。</li>
<li>PROPAGATION_NOT_SUPPORTED ，这个也可以从字面得知，not supported ，不支持，当前级别的特点就是上下文中存在事务，则挂起事务，执行当前逻辑，结束后恢复上下文的事务。<br>
这个级别有什么好处？可以帮助你将事务极可能的缩小。我们知道一个事务越大，它存在的风险也就越多。所以在处理事务的过程中，要保证尽可能的缩小范围。比如一段代码，是每次逻辑操作都必须调用的，比如循环1000次的某个非核心业务逻辑操作。这样的代码如果包在事务中，势必造成事务太大，导致出现一些难以考虑周全的异常情况。所以这个事务这个级别的传播级别就派上用场了。用当前级别的事务模板抱起来就可以了。</li>
<li>PROPAGATION_NEVER ，该事务更严格，上面一个事务传播级别只是不支持而已，有事务就挂起，而PROPAGATION_NEVER传播级别要求上下文中不能存在事务，一旦有事务，就抛出runtime异常，强制停止执行！这个级别上辈子跟事务有仇。</li>
<li>PROPAGATION_NESTED ，字面也可知道，nested，嵌套级别事务。该传播级别特征是，如果上下文中存在事务，则嵌套事务执行，如果不存在事务，则新建事务。<br>
嵌套是子事务套在父事务中执行，子事务是父事务的一部分，在进入子事务之前，父事务建立一个回滚点，叫save point，然后执行子事务，这个子事务的执行也算是父事务的一部分，然后子事务执行结束，父事务继续执行。重点就在于那个save point。看几个问题就明了了：
<ul>
<li>如果子事务回滚，会发生什么？<br>
父事务会回滚到进入子事务前建立的save point，然后尝试其他的事务或者其他的业务逻辑，父事务之前的操作不会受到影响，更不会自动回滚。</li>
<li>如果父事务回滚，会发生什么？<br>
父事务回滚，子事务也会跟着回滚！为什么呢，因为父事务结束之前，子事务是不会提交的，我们说子事务是父事务的一部分，正是这个道理。那么：</li>
<li>事务的提交，是怎样的顺序？<br>
是父事务先提交，然后子事务提交，还是子事务先提交，父事务再提交？答案是第二种情况，还是那句话，子事务是父事务的一部分，由父事务统一提交。</li>
</ul>
</li>
</ol>
<h2 id="事务隔离级别-db"><a class="header-anchor" href="#事务隔离级别-db">¶</a>事务隔离级别（DB）</h2>
<p>事务隔离级别定义的是事务在数据库读写方面的控制范围</p>
<ol>
<li>Serializable（对事务本身加锁）：最严格的级别，事务串行执行，资源消耗最大；</li>
<li>REPEATABLE READ（乐观锁？）：保证了一个事务不会修改已经由另一个事务读取但未提交（回滚）的数据。避免了“脏读取”和“不可重复读取”的情况，但是带来了更多的性能损失。</li>
<li>READ COMMITTED（互斥锁？）：大多数主流数据库的默认事务等级，保证了一个事务不会读到另一个并行事务已修改但未提交的数据，避免了“脏读取”。该级别适用于大多数系统。</li>
<li>Read Uncommitted ：保证了读取过程中不会读取到非法数据。</li>
</ol>
<p>事务隔离级别 | Dirty reads | non-repeatable reads | phantom reads<br>
Serializable | 不会 | 不会 | 不会<br>
REPEATABLE READ | 不会 | 不会 | 会<br>
READ COMMITTED | 不会 | 会 | 会<br>
Read Uncommitted | 会 | 会 | 会</p>
<h2 id="事务常用属性-spring-transactional"><a class="header-anchor" href="#事务常用属性-spring-transactional">¶</a>事务常用属性（Spring - Transactional）</h2>
<ul>
<li>readonly<br>
设置事务为只读以提升性能</li>
<li>timeout<br>
设置事务的超时时间，一般用于防止大事务的发生（事务应该尽可能小）</li>
</ul>
<h2 id="实现事务隔离级别"><a class="header-anchor" href="#实现事务隔离级别">¶</a>实现事务隔离级别</h2>
<ol>
<li>数据库层</li>
<li>JDBC驱动</li>
<li>MyBatis框架</li>
<li>Spring框架</li>
</ol>
<h3 id="mysql数据库为我们提供四种隔离级别："><a class="header-anchor" href="#mysql数据库为我们提供四种隔离级别：">¶</a>MySQL数据库为我们提供四种隔离级别：</h3>
<ul>
<li>Serializable (串行化)：可避免脏读、不可重复读、幻读的发生。</li>
<li>（默认）Repeatable read (可重复读)：可避免脏读、不可重复读的发生。</li>
<li>Read committed (读已提交)：可避免脏读的发生。</li>
<li>Read uncommitted (读未提交)：最低级别，任何情况都无法保证。</li>
</ul>
<p>修改隔离级别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select @@tx_isolation;</span><br><span class="line">mysql&gt; set transaction isolation level repeatable read;</span><br><span class="line">mysql&gt; set tx_isolation=&apos;read-uncommitted&apos;;</span><br></pre></td></tr></table></figure>
<h3 id="jdbc驱动"><a class="header-anchor" href="#jdbc驱动">¶</a>JDBC驱动</h3>
<p>JDBC的一切行为包括事务是基于一个Connection的，在JDBC中是通过Connection对象进行事务管理。在JDBC中，常用的和事务相关的方法是：setAutoCommit、commit、rollback等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conn.setTransactionIsolation(Connection.TRANSACTION_SERIALIZABLE);</span><br><span class="line">conn.setAutoCommit(false);</span><br></pre></td></tr></table></figure>
<ul>
<li>Connection类提供几个静态成员变量可作为事务的级别。</li>
<li>设置事务必须在调用setAutoCommit(false)开启事务之前。设置为 true （默认）则sql命令的提交（commit）由驱动程序负责、数据库将会把每一次数据更新认定为一个事务并自动提交；若为false则sql命令的提交由应用程序负责，程序必须调用commit或者rollback方法</li>
<li>一个Connection对象相当于一次session，只在一次数据库访问期间有效。</li>
</ul>
<h3 id="spring框架事务隔离级别"><a class="header-anchor" href="#spring框架事务隔离级别">¶</a>Spring框架事务隔离级别</h3>
<p>PROPAGATION_REQUIRED:<br>
如果存在一个事务，则支持当前事务。如果没有事务则开启。<br>
PROPAGATION_SUPPORTS:<br>
如果存在一个事务，支持当前事务。如果没有事务，则非事务的执行。<br>
PROPAGATION_MANDATORY:<br>
如果已经存在一个事务，支持当前事务。如果没有一个活动的事务，则抛出异常。<br>
PROPAGATION_REQUIRES_NEW:<br>
总是开启一个新的事务。如果一个事务已经存在，则将这个存在的事务挂起。<br>
PROPAGATION_NOT_SUPPORTED:<br>
总是非事务地执行，并挂起任何存在的事务。<br>
PROPAGATION_NEVER:<br>
总是非事务地执行，如果存在一个活动事务，则抛出异常。<br>
PROPAGATION_NESTED：<br>
如果一个活动的事务存在，则运行在一个嵌套的事务中. 如果没有活动事务, 则按TransactionDefinition.PROPAGATION_REQUIRED 属性执行。</p>
<h3 id="spring-事务的实现原理"><a class="header-anchor" href="#spring-事务的实现原理">¶</a>Spring 事务的实现原理</h3>
<p>源码入口可以看<code>TransactionAspectSupport#invokeWithinTransaction</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">// 从方法的@Transactional注解中获取事务属性</span><br><span class="line">final TransactionAttribute txAttr = getTransactionAttributeSource().getTransactionAttribute(method, targetClass);</span><br><span class="line">// 获取事务管理器</span><br><span class="line">final PlatformTransactionManager tm = determineTransactionManager(txAttr);</span><br><span class="line">final String joinpointIdentification = methodIdentification(method, targetClass);</span><br><span class="line"></span><br><span class="line">if (txAttr == null || !(tm instanceof CallbackPreferringPlatformTransactionManager)) &#123;</span><br><span class="line">    // 创建事务信息，包含事务管理器和事务状态</span><br><span class="line">    TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);</span><br><span class="line">    Object retVal = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        // 执行目标方法</span><br><span class="line">        retVal = invocation.proceedWithInvocation();</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        // 回滚</span><br><span class="line">        completeTransactionAfterThrowing(txInfo, ex);</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        // 清理当前线程的事务相关信息</span><br><span class="line">        cleanupTransactionInfo(txInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    // 提交事务</span><br><span class="line">    commitTransactionAfterReturning(txInfo);</span><br><span class="line">    return retVal;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected TransactionInfo createTransactionIfNecessary(</span><br><span class="line">        PlatformTransactionManager tm, TransactionAttribute txAttr, final String joinpointIdentification) &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    TransactionStatus status = null;</span><br><span class="line">    if (txAttr != null) &#123;</span><br><span class="line">        if (tm != null) &#123;</span><br><span class="line">            // 从事务管理器获取当前事务状态</span><br><span class="line">            status = tm.getTransaction(txAttr);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Skipping transactional joinpoint [&quot; + joinpointIdentification +</span><br><span class="line">                        &quot;] because no transaction manager has been configured&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1、createTransactionIfNecessary<br>
准备事务状态，主要任务是开启事务，即调用JDBC的con.setAutoCommit(false)<br>
2、proceedWithInvocation<br>
执行目标方法<br>
3、事务管理器<br>
事务管理器可以提供数据源的接口，包括begin、commit、rollback等。<br>
事务状态也由TransactionManager保存，表示事务当前执行的阶段。<br>
4、事务的传播<br>
Spring事务的传播级别描述的是多个使用了@Transactional注解的方法互相调用时，Spring对事务的处理。<br>
事务传播的实现原理主要看两个角度：一个角度是刚进入事务时，针对不同的传播级别，它们的行为有什么区别，另一个角度是当事务提交或回滚时，传播级别对事务行为的影响。<br>
也就是上边源码中的<code>createTransactionIfNecessary</code>和<code>completeTransactionAfterThrowing</code>这两个入口。<br>
这里标记出了源码的入口，但是我并没有再继续深入捋事务传播机制的实现原理了，想必也不会是特别复杂的。<br>
refer: <a href="https://blog.csdn.net/weixin_44366439/article/details/89030080" target="_blank" rel="noopener">https://blog.csdn.net/weixin_44366439/article/details/89030080</a></p>
<h1>分布式事务</h1>
<h2 id="一致性-cap与base"><a class="header-anchor" href="#一致性-cap与base">¶</a>一致性、CAP与BASE</h2>
<h2 id="柔性事务和刚性事务"><a class="header-anchor" href="#柔性事务和刚性事务">¶</a>柔性事务和刚性事务</h2>
<p>刚性事务是指严格遵循ACID原则的事务, 例如单机环境下的数据库事务.<br>
柔性事务是指遵循BASE理论的事务, 通常用在分布式环境中, 常见的实现方式有: 两阶段提交(2PC), TCC补偿型提交, 基于消息的异步确保型, 最大努力通知型.<br>
通常对本地事务采用刚性事务, 分布式事务使用柔性事务.</p>
<h2 id="最佳实践"><a class="header-anchor" href="#最佳实践">¶</a>最佳实践</h2>
<p>如果业务场景需要强一致性, 那么尽量避免将它们放在不同服务中, 也就是尽量使用<strong>本地事务</strong>, 避免使用强一致性的分布式事务.<br>
如果业务场景能够接受最终一致性, 那么最好是使用<strong>基于消息的最终一致性的方案</strong>(异步确保型)来解决.<br>
如果业务场景需要强一致性, 并且只能够进行分布式服务部署, 那么最好是使用<strong>TCC方案</strong>而不是2PC方案来解决.</p>
<h2 id="幂等性"><a class="header-anchor" href="#幂等性">¶</a>幂等性</h2>
<p>幂等性则是指业务方法调用一次与调用多次的执行返回结果是一样的。分布式事务的设计中一般会需要服务接口提供者再提供一个逆向操作接口，在正向接口失败后被调用，以实现事务补偿机制。正向接口和逆向接口都是有可能被重试调用的，因此将接口设计成幂等的是必须的。</p>
<h2 id="分布式一致性"><a class="header-anchor" href="#分布式一致性">¶</a>分布式一致性</h2>
<p>在分布式系统中，为了保证数据的高可用，通常，我们会将数据保留多个副本(replica)，这些副本会放置在不同的物理的机器上。为了对用户提供正确的增\删\改\差等语义，我们需要保证这些放置在不同物理机器上的副本是一致的。<br>
一般来说一致性是必须满足的，不然那个系统就是完全不可靠的了，我们说在某些场景下需要牺牲一致性，指的是牺牲强一致性。</p>
<h2 id="数据一致性"><a class="header-anchor" href="#数据一致性">¶</a>数据一致性</h2>
<p>通常情况下，我们所说的分布式一致性问题通常指的是数据一致性问题。<br>
数据一致性其实是数据库系统中的概念。我们可以简单的把一致性理解为正确性或者完整性，那么数据一致性通常指关联数据之间的逻辑关系是否正确和完整。我们知道，在数据库系统中通常用事务（访问并可能更新数据库中各种数据项的一个程序执行单元）来保证数据的一致性和完整性。而在分布式系统中，数据一致性往往指的是由于数据的复制，不同数据节点中的数据内容是否完整并且相同。<br>
为了提高可用性，我们往往会将数据复制到多台服务器上，以消除单点故障问题，然后使用负载均衡来提高整个系统的性能。在分布式系统引入复制机制后，不同的数据节点之间由于网络延时等原因很容易产生数据不一致的情况。<br>
比如两个用户访问一个服务的两个实例，两个实例都知道票只有一张，所以他们都会提示购票成功，但是整个系统也只有这一张票的情况下，必须得有一个用户手上的票作废，或者说购票不成功。</p>
<h2 id="一致性模型"><a class="header-anchor" href="#一致性模型">¶</a>一致性模型</h2>
<h3 id="强一致性"><a class="header-anchor" href="#强一致性">¶</a>强一致性</h3>
<p>当更新操作完成之后，任何多个后续进程或者线程的访问都会返回最新的更新过的值。这种是对用户最友好的，就是用户上一次写什么，下一次就保证能读到什么。但是这种实现对性能影响较大。</p>
<h3 id="弱一致性"><a class="header-anchor" href="#弱一致性">¶</a>弱一致性</h3>
<p>系统并不保证续进程或者线程的访问都会返回最新的更新过的值。系统在数据写入成功之后，不承诺立即可以读到最新写入的值，也不会具体的承诺多久之后可以读到。但会尽可能保证在某个时间级别（比如秒级别）之后，可以让数据达到一致性状态。</p>
<h3 id="最终一致性"><a class="header-anchor" href="#最终一致性">¶</a>最终一致性</h3>
<p>弱一致性的特定形式。系统保证在没有后续更新的前提下，系统最终返回上一次更新操作的值。在没有故障发生的前提下，不一致窗口的时间主要受通信延迟，系统负载和复制副本的个数影响。DNS是一个典型的最终一致性系统。</p>
<h3 id="最终一致性模型的变种"><a class="header-anchor" href="#最终一致性模型的变种">¶</a>最终一致性模型的变种</h3>
<ul>
<li>因果一致性：如果A进程在更新之后向B进程通知更新的完成，那么B的访问操作将会返回更新的值。如果没有因果关系的C进程将会遵循最终一致性的规则。</li>
<li>读己所写一致性：因果一致性的特定形式。一个进程总可以读到自己更新的数据。</li>
<li>会话一致性：读己所写一致性的特定形式。进程在访问存储系统同一个会话内，系统保证该进程读己之所写。</li>
<li>单调读一致性：如果一个进程已经读取到一个特定值，那么该进程不会读取到该值以前的任何值。</li>
<li>单调写一致性：系统保证对同一个进程的写操作串行化。</li>
<li>上述最终一致性的不同方式可以进行组合，例如单调读一致性和读己之所写一致性就可以组合实现。并且从实践的角度来看，这两者的组合，读取自己更新的 数据，和一旦读取到最新的版本不会再读取旧版本，对于此架构上的程序开发来说，会少很多额外的烦恼。</li>
</ul>
<h2 id="分布式事务"><a class="header-anchor" href="#分布式事务">¶</a>分布式事务</h2>
<p>分布式事务是指会涉及到操作多个数据库的事务。其实就是将对同一库事务的概念扩大到了对多个库的事务。目的是为了保证分布式系统中的数据一致性。分布式事务处理的关键是必须有一种方法可以知道事务在任何地方所做的所有动作，提交或回滚事务的决定必须产生统一的结果（全部提交或全部回滚）。<br>
常用的几个方案：</p>
<ol>
<li>XA两阶段提交<br>
锁定资源时间长，对性能影响大，不适合微服务场景。</li>
<li>TCC方案<br>
对应用侵入性强，实现难度大。</li>
<li>基于消息的最终一致性方案<br>
侵入性强，需要对业务进行大量改造，成本较高。</li>
</ol>
<h2 id="分布式事务的替代方案"><a class="header-anchor" href="#分布式事务的替代方案">¶</a>分布式事务的替代方案</h2>
<h3 id="补偿事务"><a class="header-anchor" href="#补偿事务">¶</a>补偿事务</h3>
<p>在业务端实施业务逆向操作事务。<br>
包括正向（重试）和逆向（回滚）两个部分，</p>
<p>补偿事务有什么缺点？</p>
<ul>
<li>不同的业务要写不同的补偿事务，不具备通用性；</li>
<li>没有考虑补偿事务的失败；</li>
<li>如果业务流程很复杂，if/else会嵌套非常多层；</li>
</ul>
<h2 id="应用场景"><a class="header-anchor" href="#应用场景">¶</a>应用场景</h2>
<h3 id="支付"><a class="header-anchor" href="#支付">¶</a>支付</h3>
<p>最经典的场景就是支付了，一笔支付，是对买家账户进行扣款，同时对卖家账户进行加钱，这些操作必须在一个事务里执行，要么全部成功，要么全部失败。而对于买家账户属于买家中心，对应的是买家数据库，而卖家账户属于卖家中心，对应的是卖家数据库，对不同数据库的操作必然需要引入分布式事务。</p>
<h3 id="在线下单"><a class="header-anchor" href="#在线下单">¶</a>在线下单</h3>
<p>买家在电商平台下单，往往会涉及到两个动作，一个是扣库存，第二个是更新订单状态，库存和订单一般属于不同的数据库，需要使用分布式事务保证数据一致性。</p>
<h2 id="参考"><a class="header-anchor" href="#参考">¶</a>参考</h2>
<h3 id="概念理解"><a class="header-anchor" href="#概念理解">¶</a>概念理解</h3>
<ol>
<li><a href="https://en.m.wikipedia.org/wiki/ACID_transactions" target="_blank" rel="noopener">ACID</a></li>
<li><a href="http://www.linkedkeeper.com/detail/blog.action?bid=1013" target="_blank" rel="noopener">浅谈分布式事务</a></li>
<li>分布式系统常见的事务处理机制 <a href="https://waylau.com/distributed-system-transaction/" target="_blank" rel="noopener">https://waylau.com/distributed-system-transaction/</a></li>
<li>分布式系统的事务处理 <a href="https://coolshell.cn/articles/10910.html" target="_blank" rel="noopener">https://coolshell.cn/articles/10910.html</a></li>
<li>分布式系统事务一致性解决方案 <a href="http://www.infoq.com/cn/articles/solution-of-distributed-system-transaction-consistency" target="_blank" rel="noopener">http://www.infoq.com/cn/articles/solution-of-distributed-system-transaction-consistency</a></li>
<li>分布式服务的事务如何处理？比如dubbo，服务与服务之间的事务怎么处理比较好，现在有没有开源的解决方案？ <a href="https://www.zhihu.com/question/29483490" target="_blank" rel="noopener">https://www.zhihu.com/question/29483490</a></li>
<li><a href="https://www.zhihu.com/question/48627764/answer/259103512" target="_blank" rel="noopener">如何理解TCC分布式事务?</a></li>
</ol>
<h3 id="方案"><a class="header-anchor" href="#方案">¶</a>方案</h3>
<ol>
<li><a href="http://xiaorui.cc/2016/02/25/%E7%90%86%E8%A7%A3%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A42pc/" target="_blank" rel="noopener">理解分布式事务的两阶段提交2pc</a></li>
<li>如何用消息系统避免分布式事务？ <a href="http://blog.jobbole.com/89140/" target="_blank" rel="noopener">http://blog.jobbole.com/89140/</a><br>
<a href="http://blog.csdn.net/congyihao/article/details/70195154" target="_blank" rel="noopener">微服务–分布式事务的实现方法及替代方案</a></li>
<li><a href="http://www.roncoo.com/article/detail/124243" target="_blank" rel="noopener">微服务架构的分布式事务解决方案</a></li>
<li><a href="https://help.aliyun.com/document_detail/29548.html?spm=5176.doc29558.6.575.CPDsKK" target="_blank" rel="noopener">收发事务消息</a></li>
<li><a href="https://www.zhihu.com/question/31813039" target="_blank" rel="noopener">支付宝运营架构中柔性事务指的是什么？</a></li>
<li><a href="https://www.cnblogs.com/rainwang/p/7099648.html" target="_blank" rel="noopener">TCC事务机制简介</a></li>
<li><a href="https://github.com/clsaa/Distributed-Transaction-Notes/blob/master/5-TCC%E5%9E%8B%E6%96%B9%E6%A1%88.md" target="_blank" rel="noopener">Distributed-Transaction-Notes</a></li>
<li><a href="https://mp.weixin.qq.com/s/FMvAqmN8SHhLqMssAlAR8Q" target="_blank" rel="noopener">微服务架构下处理分布式事务，你必须知道的事儿</a></li>
<li><a href="https://mp.weixin.qq.com/s/MWy9LjWtC9d7mrBxh745Jw" target="_blank" rel="noopener">支付核心系统设计：Airbnb的分布式事务方案简介</a></li>
</ol>
<h3 id="实现"><a class="header-anchor" href="#实现">¶</a>实现</h3>
<ol>
<li><a href="https://segmentfault.com/q/1010000005998615" target="_blank" rel="noopener">TCC分布式事务实现原理</a></li>
<li><a href="https://github.com/prontera/spring-cloud-rest-tcc" target="_blank" rel="noopener">spring-cloud-rest-tcc</a></li>
<li><a href="https://github.com/zeq9069/tcc-transaction" target="_blank" rel="noopener">tcc-transaction</a></li>
<li><a href="http://blog.csdn.net/qq_17612199/article/details/74826099" target="_blank" rel="noopener">tcc-transaction 执行流程源码分析</a></li>
<li><a href="http://www.iocoder.cn/categories/TCC-Transaction/" target="_blank" rel="noopener">芋道源码</a></li>
<li><a href="http://geek.csdn.net/news/detail/240045" target="_blank" rel="noopener">TCC分布式事务框架源码解析系列（一）之项目结构</a></li>
<li><a href="https://www.atomikos.com/Blog/TransactionManagementAPIForRESTTCC" target="_blank" rel="noopener">Transaction management API for REST: TCC</a></li>
</ol>
<h3 id="bytetcc"><a class="header-anchor" href="#bytetcc">¶</a>ByteTCC</h3>
<ol>
<li><a href="https://wenku.baidu.com/view/be946bec0975f46527d3e104.html" target="_blank" rel="noopener">大规模SOA系统中的分布事务处事_程立</a></li>
<li><a href="http://www.bytesoft.org/" target="_blank" rel="noopener">ByteTCC</a></li>
<li><a href="https://github.com/liuyangming/ByteTCC" target="_blank" rel="noopener">liuyangming/ByteTCC</a></li>
</ol>
<h3 id="事务补偿机制"><a class="header-anchor" href="#事务补偿机制">¶</a>事务补偿机制</h3>
<ol>
<li><a href="https://blog.csdn.net/yuliying/article/details/52813302" target="_blank" rel="noopener">事务补偿机制</a></li>
</ol>
<h3 id="幂等性-v2"><a class="header-anchor" href="#幂等性-v2">¶</a>幂等性</h3>
<ol>
<li><a href="https://www.zhihu.com/question/27744795" target="_blank" rel="noopener">分布式高并发系统如何保证对外接口的幂等性？</a></li>
<li><a href="http://outofmemory.cn/wiki/service-idempotency" target="_blank" rel="noopener">服务幂等以及常用实现方式</a></li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/本地事务/" rel="tag"># 本地事务</a>
          
            <a href="/tags/分布式事务/" rel="tag"># 分布式事务</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/6a07ad6.html" rel="next" title="Redis 性能调优">
                <i class="fa fa-chevron-left"></i> Redis 性能调优
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/f5668bf0.html" rel="prev" title="分布式系统的设计原理">
                分布式系统的设计原理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div id="gitalk-container"></div>

  

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">tallate</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">153</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">74</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">单机事务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#acid"><span class="nav-number">1.1.</span> <span class="nav-text">¶ACID</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三个问题"><span class="nav-number">1.2.</span> <span class="nav-text">¶三个问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务传播级别-spring"><span class="nav-number">1.3.</span> <span class="nav-text">¶事务传播级别（Spring）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务隔离级别-db"><span class="nav-number">1.4.</span> <span class="nav-text">¶事务隔离级别（DB）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务常用属性-spring-transactional"><span class="nav-number">1.5.</span> <span class="nav-text">¶事务常用属性（Spring - Transactional）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现事务隔离级别"><span class="nav-number">1.6.</span> <span class="nav-text">¶实现事务隔离级别</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#mysql数据库为我们提供四种隔离级别："><span class="nav-number">1.6.1.</span> <span class="nav-text">¶MySQL数据库为我们提供四种隔离级别：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jdbc驱动"><span class="nav-number">1.6.2.</span> <span class="nav-text">¶JDBC驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring框架事务隔离级别"><span class="nav-number">1.6.3.</span> <span class="nav-text">¶Spring框架事务隔离级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring-事务的实现原理"><span class="nav-number">1.6.4.</span> <span class="nav-text">¶Spring 事务的实现原理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">分布式事务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一致性-cap与base"><span class="nav-number">2.1.</span> <span class="nav-text">¶一致性、CAP与BASE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#柔性事务和刚性事务"><span class="nav-number">2.2.</span> <span class="nav-text">¶柔性事务和刚性事务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最佳实践"><span class="nav-number">2.3.</span> <span class="nav-text">¶最佳实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#幂等性"><span class="nav-number">2.4.</span> <span class="nav-text">¶幂等性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式一致性"><span class="nav-number">2.5.</span> <span class="nav-text">¶分布式一致性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据一致性"><span class="nav-number">2.6.</span> <span class="nav-text">¶数据一致性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一致性模型"><span class="nav-number">2.7.</span> <span class="nav-text">¶一致性模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#强一致性"><span class="nav-number">2.7.1.</span> <span class="nav-text">¶强一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#弱一致性"><span class="nav-number">2.7.2.</span> <span class="nav-text">¶弱一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#最终一致性"><span class="nav-number">2.7.3.</span> <span class="nav-text">¶最终一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#最终一致性模型的变种"><span class="nav-number">2.7.4.</span> <span class="nav-text">¶最终一致性模型的变种</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式事务"><span class="nav-number">2.8.</span> <span class="nav-text">¶分布式事务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式事务的替代方案"><span class="nav-number">2.9.</span> <span class="nav-text">¶分布式事务的替代方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#补偿事务"><span class="nav-number">2.9.1.</span> <span class="nav-text">¶补偿事务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用场景"><span class="nav-number">2.10.</span> <span class="nav-text">¶应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#支付"><span class="nav-number">2.10.1.</span> <span class="nav-text">¶支付</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在线下单"><span class="nav-number">2.10.2.</span> <span class="nav-text">¶在线下单</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">2.11.</span> <span class="nav-text">¶参考</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概念理解"><span class="nav-number">2.11.1.</span> <span class="nav-text">¶概念理解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方案"><span class="nav-number">2.11.2.</span> <span class="nav-text">¶方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现"><span class="nav-number">2.11.3.</span> <span class="nav-text">¶实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bytetcc"><span class="nav-number">2.11.4.</span> <span class="nav-text">¶ByteTCC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事务补偿机制"><span class="nav-number">2.11.5.</span> <span class="nav-text">¶事务补偿机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#幂等性-v2"><span class="nav-number">2.11.6.</span> <span class="nav-text">¶幂等性</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        

<div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tallate</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.3</div>








        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 访问总量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '72bdd1c9479eb0679788',
          clientSecret: '62c9c0cb45aadb1478ca66cfc3c69c9623f50290',
          repo: 'tallate.github.io',
          owner: 'tallate',
          admin: ['tallate'],
          id: location.pathname,
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')           
       </script>



  





  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  


</body>
</html>
