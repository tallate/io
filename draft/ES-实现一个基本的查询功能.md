---
title: ES-实现一个基本的查询功能
date: 2019-07-29 20:14:29
categories: 知识点总结
tags: [ElasticSearch]
---

## 为什么用ElasticSearch
Elasticsearch 是一个分布式、可扩展、实时的搜索与数据分析引擎。大致上，它有以下重要特征：
* 面向文档
* Lucene索引
* 分布式

下面是ES与其他数据库之间的比较，主要关注点在于搜索和集群特性：
周 | 一 | 二 | 
-- | - | - | - | - | - | - | -
ElasticSearch | 10 | 11 | 20 | 13 | 休息 | 30 | 休息
MySQL | 10 | 11 | 20 | 13 | 休息 | 30 | 休息
MongoDB | 10 | 11 | 20 | 13 | 休息 | 30 | 休息

## 基本概念
Relational DB -> Databases -> Tables -> Rows -> Columns
Elasticsearch -> Indices -> Types -> Documents -> Fields
> 将Type类比为Table并不恰当，因为ES中一个索引下的多个类型共用相同的空间。
### 集群 - Cluster
一个集群就是由一个或多个节点组织在一起， 它们共同持有全部的数据。
一个集群由一个唯一的名字标识，其节点只能通过指定某个集群的名字，来加入这个集群。

### 节点 - Node
一个节点是集群中的一个服务器，即一个es实例。
作为集群的一部分，它存储数据，参与集群的索引和搜索功能。

### 索引 - Index、Type
一个**索引(index)**就像是传统关系数据库中的数据库，它是相关文档存储的地方，实际上是组织数据的逻辑**命名空间**。
在一个索引中，可以定义一种或多种**类型**，一个类型是索引的一个逻辑上的分类。但是在ES 6.0.0以后，这个概念会被废弃。

### 文档和字段 - Document、Field
一个文档是一个可被索引的基础信息单元，文档以JSON格式来表示。
在一个index/type里面，可以存储任意多的文档，每个文档都有唯一id。
每个文档包含多个字段(fields)，即json数据里的字段。

## 集群原理
### 分片（Shard）
分片是物理存储范畴的概念。
一个索引可以被划分成多个分片，创建索引时可指定分片数量，默认是5。
每个分片是一个Lucene实例，它本身也是一个功能完善并且独立的“索引”，这个“索引” 可以被放置到集群中的任何节点上。
分片是ES中集群管理的最小单位，在此基础上，ES允许：
* 允许你水平分割/扩展你的内容容量
* 允许你在分片（位于多个节点上）之上进行分布式的、并行的操作，进而提高性能/吞吐量

分片类似DB里的分库分表，是为了解决数据量很大查询效率低下的问题，同时突破单节点磁盘限制。
集群的配置非常灵活，比如对于一个需要占据100G磁盘空间的索引，5个分片每个分片大小20G，假设单节点磁盘上限100G，可以有以下几种方案：
1. 单节点一个分片：单次只能在100G数据里查询一条数据，磁盘占用率100%。
1. 单节点5个分片：每个分片存储20G数据，可以5个任务并行查询，磁盘占用率100%，索引大小上限100G，无法再插入新数据。
1. 集群（2个节点）5个分片：一个节点3片，另一个节点2片，可以并行查找，同时单节点磁盘占用量 <60%，索引最大存储上限为200G。
1. 集群（5个节点）5个分片：每个节点包含一个分片，单节点磁盘占用量20%，索引最大存储上限为500G。

至于是否有最佳实践，我认为还是得根据实际场景来说话，比如就简单搭建一个开发环境来说，单节点（单分片或多分片）足够，当然，因为没有荣誉，硬件故障时会有数据丢失风险。


### 复制（Replica）
Elasticsearch允许创建分片的一份或多份拷贝（默认复制1份），这些拷贝叫做复制分片。
在分片/节点失败的情况下，复制提供了高可用性。
因为搜索可以在所有的复制上并行运行，复制可以扩展你的搜索量/吞吐量
复制分片不与相同的主分片置于同一节点上，否则失去备份的意义。

总而言之：
1. 每个索引可以被分成多个分片。
1. 一个索引也可以被复制0次（即没有复制） 或多次。
1. 一旦复制了，每个索引就有了主分片（作为复制源的分片）和复制分片（主分片的拷贝）。
1. 分片和复制的数量可以在索引创建的时候指定。在索引创建之后，可以在任何时候动态地改变复制的数量，但是不能再改变分片的数量。

至于ES集群中如何分配分片与备份，都是ES内部维护管理的，对用户完全透明。

### 集群相关命令
```
# 测试环境es集群状态查看
curl http://ip:9219/_cluster/health
```
返回值中，status 字段指示着当前集群在总体上是否工作正常，它的三种颜色含义如下：
* green：所有的主分片和副本分片都正常运行。
* yellow：所有的主分片都正常运行，但不是所有的副本分片都正常运行。
* red：  有主分片没能正常运行。

    





