---
title: 平滑迁移-高速飞机换引擎
categories: 设计
tags: Distributed System
abbrlink: fd8cde90
date: 2019-09-02 23:12:49
---


平滑迁移指的是互联网公司发版时为能正常发布新功能而又不影响用户体验所做的一些措施。
<!-- more -->

## 为什么要做平滑迁移？
平滑迁移非常常见，现在的互联网公司每天发布好几版再正常不过，老的设计如果不向上兼容，就必须额外设计一套平滑发布方案。
平滑迁移的基本目标是不停服，升级期间访问服务会出错或入口被封闭都不能称为平滑迁移。
平滑迁移并不存在银弹，可以说有多少套技术就有多少套平滑迁移的方案，比如：
* 业务逻辑迁移,这种场景是最常见的，比如订单列表原来依照下单时间正序排序，现在要改成倒序，发布时就不能照常地灰度发布，因为发布到一半时，部分请求会打到新版本服务器，部分请求会打到老版本服务器，导致一会正着排、一会倒着排的情况；
* 中间件迁移，比如Memcache迁移到Redis、ActiveMQ迁移到RocketMQ；
> 为了方便起见，我直接将数据库归类到中间件里，这么归类是合理的，因为现在很少公司会采用存储过程、触发器这些需要编写业务逻辑的功能，数据库基本只负责存储。

迁移最麻烦的不是代码的切换，而是由代码逻辑变更连带的数据迁移，大概可以分为以下几类：
* 缓存迁移；
* 消息队列迁移；
* 服务注册中心迁移；
* 数据库迁移；
> 这里忽略了很多其他中间件，那些并非不重要，只是我将我认为最常见和

## 业务迁移


## MQ迁移
原MQ（暂时称之为OMQ）太老架构臃肿且无人能完全掌握、考虑迁移到新的一套MQ（暂时称之为NMQ），但是经过很长一段时间的迭代，业务系统已经积累了大量的消息主题、消息满天飞，这种情况下，如何设计平滑发布方案？
### MQ架构
一般MQ的架构由消息发送方（Producer）、接收方（Consumer）和MQ服务器组成。，
### 平滑迁移方案
对每个主题来说，迁移分为三个步骤：
![MQ平滑迁移](http://47.88.24.11/imgs/平滑迁移-高速飞机换引擎/MQ平滑迁移.png "MQ平滑迁移")
1. Consumer双向订阅
新Consumer服务订阅OMQ和NMQ的相同主题，保证消息不会漏掉；
1. Producer发布到NMQ
Producer改为发布消息到NMQ。
1. Consumer下线旧订阅
等OMQ中的消息被消费完毕后，可以令Consumer取消对OMQ的订阅，从而完成MQ的迁移。

更优方案是对依赖的MQ进行封装，业务代码并不知道底层使用的是ActiveMQ、RocketMQ还是什么MQ，这样迁移完全可以通过升级依赖的基础组件来进行，业务代码不需要修改。


## 存储平滑迁移
### DB迁移

### DB扩容

### MQ迁移


