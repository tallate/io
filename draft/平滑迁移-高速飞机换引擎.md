---
title: 平滑迁移-高速飞机换引擎
categories: 设计
tags: Distributed System
abbrlink: fd8cde90
date: 2019-09-02 23:12:49
---


平滑迁移指的是互联网公司发版时为能正常发布新功能而又不影响用户体验所做的一些措施。
<!-- more -->

## 为什么要做平滑迁移
平滑迁移非常常见，现在的互联网公司每天发布好几版再正常不过，老的设计如果不向上兼容，就必须额外设计一套平滑发布方案。
平滑迁移的基本目标是不停服，升级期间访问服务会出错或入口被封闭都不能称为平滑迁移。
平滑迁移并不存在银弹，可以说有多少套技术就有多少套平滑迁移的方案，比如：
* 业务逻辑迁移,这种场景是最常见的，比如订单列表原来依照下单时间正序排序，现在要改成倒序，发布时就不能照常地灰度发布，因为发布到一半时，部分请求会打到新版本服务器，部分请求会打到老版本服务器，导致一会正着排、一会倒着排的情况；
* 中间件迁移，比如 Memcache 迁移到 Redis、ActiveMQ 迁移到 RocketMQ；
> 为了方便起见，我直接将数据库归类到中间件里，这么归类是合理的，因为现在很少公司会采用存储过程、触发器这些需要编写业务逻辑的功能，数据库基本只负责存储。

迁移最麻烦的不是代码的切换，而是由代码逻辑变更连带的数据迁移，大概可以分为以下几类：
* 缓存迁移；
* 消息队列迁移；
* 服务注册中心迁移，一些RPC框架与服务注册表强关联，比如Dubbo；
* 数据库迁移，包括扩容，常见方式是分库分表；
> 这里忽略了很多其他中间件，那些并非不重要，只是我将我认为最常见和典型的罗列了出来。


## 业务迁移
业务迁移是最简单、也是最复杂的，简单简单在每次业务开发几乎都需要做，这对于我们来说就像喝水一样；难则难在业务总是会越变越复杂，几年后就会变得非常难以维护了。


## MQ 迁移
原 MQ（暂时称之为 OMQ）太老架构臃肿且无人能完全掌握、考虑迁移到新的一套 MQ（暂时称之为 NMQ），但是经过很长一段时间的迭代，业务系统已经积累了大量的消息主题、消息满天飞，这种情况下，如何设计平滑发布方案？
### MQ 架构
一般 MQ 的架构由消息发送方（Producer）、接收方（Consumer）和 MQ 服务器组成。，

### 平滑迁移方案
对每个主题来说，迁移分为三个步骤：
![MQ平滑迁移](http://47.88.24.11/imgs/平滑迁移-高速飞机换引擎/MQ平滑迁移.png "MQ平滑迁移")
1. Consumer 双向订阅
新 Consumer 服务订阅 OMQ 和 NMQ 的相同主题，保证消息不会漏掉；
1. Producer 发布到 NMQ
Producer 改为发布消息到 NMQ。
1. Consumer 下线旧订阅
等 OMQ 中的消息被消费完毕后，可以令 Consumer 取消对 OMQ 的订阅，从而完成 MQ 的迁移。

更优方案是对依赖的 MQ 进行封装，业务代码并不知道底层使用的是 ActiveMQ、RocketMQ 还是什么 MQ，这样迁移完全可以通过升级依赖的基础组件来进行，业务代码不需要修改。


## Cache迁移
### Redis扩容


## DB 迁移
### 分库分表的时机
1. 尽量不要切分
并不是所有表都需要进行切分，因为切分后会提升业务的复杂度，如果对数据量过小的表执行切分得不偿失，属于过度设计和过早优化。
1. 数据量过大导致影响了业务的正常工作
比如数据量过大，数据库备份将很慢，对大表进行DDL修改时可能会锁表，大表更新更容易出现锁等待。
1. 数据量过大超过内存、磁盘允许容纳的极限

### 分库分表1
1. 垂直分库
垂直分库即是将一个完整的数据库根据业务功能拆分成多个独立的数据库，这些数据库可以运行在不同的服务器上，从而提升整体数据读写性能。
垂直分库常见于微服务架构，微服务之间有良好的业务边界，每个微服务都有自己独立的数据库，可以避免由于单个数据库节点压力过大从而影响系统的整体性能。
![垂直分库](http://47.88.24.11/imgs/平滑迁移-高速飞机换引擎/垂直分库.png "垂直分库")
1. 垂直分表
如果一张表的字段非常多，那么很有可能会引起数据的跨页存储，这会造成数据库额外的性能开销，这种情况可以采用垂直分表优化。
垂直分表就是将一张表中不常用的字段拆分到另一张表中，从而减少第一张表中的字段，避免出现数据库跨页存储的问题，从而提升查询效率。而另一张表中的数据通过外键与第一张表进行关联。
![垂直分表](http://47.88.24.11/imgs/平滑迁移-高速飞机换引擎/垂直分表.png "垂直分表")
1. 水平分表
一张表中的记录数过多（超过1000万条记录）会对数据库的读写性能产生较大的影响，这种情况可以采用水平分表优化。
水平分表是将一张含有很多记录数的表水平切分，拆分成几张结构相同的表。比如将order表拆分为order_0、order_1...order_99这些表，当要查找某条订单时根据`hash(user_id)%100`结果来路由到某张表，在hash函数足够均匀的情况下能达到数据的较完美拆分，从而提升订单的读写效率。
1. 水平数据分片
分表只考虑数据处于同一个库中的情况，当数据量过大时数据库仍有可能成为瓶颈，解决办法是引入水平数据分片，将表按某种分片规则存储在多台数据库服务器上，从而将单库的压力分摊到了多库上，从而避免因为数据库硬件资源有限导致的数据库性能瓶颈。

### 垂直切分
垂直切分的优点：
* 解决业务系统层面的耦合，促进业务系统的清晰；
* 与微服务的治理类似，也能对不同业务的数据进行分级管理、维护、监控等；
* 高并发场景下，垂直切分可以一定程度的提升IO、数据连接数、单机硬件资源的瓶颈。

垂直切分的缺点：
* 部分表无法join，只能通过接口聚合方式解决，提升了开发的复杂度；
* 分布式事务处理复杂；
* 依然存在单表数据量过大的问题（需要水平切分）。

### 水平切分
水平切分的优点：
* 将数据分散到多个表和库中后，解决单库数据量过大和单表过热的问题，提升系统稳定性和负载能力；
* 应用端改造较小，不需要拆分业务模块；

水平切分的缺点：
* 跨分片的事务一致性难以保证；
* 跨库的join关联查询性能较差；
* 数据扩展有技术难度且维护较复杂。

### 数据分片
当数据量达到一定规模时必然面临数据的分片，数据分片是目前解决海量数据持久化存储与高效查询的一种重要手段。
数据分库分表的过程在系统设计阶段完成，要求系统设计人员根据系统预期的业务量，将未来可能出现瓶颈的数据库、数据表按照一定规则拆分成多个库、多张表，这些数据库和数据表需要部署在不同的服务器上，从而将数据读写压力分摊至集群中的各个节点，提升数据库整体处理能力，避免出现读写瓶颈的现象。
目前数据分片的方式一共有两种：**离散分片**和**连续分片**。
#### 离散分片
离散分片是按照数据的某一字段哈希取模后进行分片存储。
* 跨分片连接查询
虽然我们希望数据是相对独立的，这样将订单路由到其所处的数据库即可进行CRUD操作，但是实际场景中可能还会有需要关联查询的情况，比如，虽然分片是通过user_id路由的，但是某个需求需要查最近1个月内的订单，这种情况下就必须轮询每个分片再将所有结果合并返回了。
目前所有关系数据库出于安全性考虑均不提供跨分片连接查询，跨库操作需要由数据分库分表中间件来完成，这会降低查询效率、且加大了系统复杂性。
* 扩容
当数据存储能力出现瓶颈需要扩容时，离散分片规则需要将所有数据重新进行哈希取模运算，成本过高，如果在系统运行期间迁移，因为新数据一直在生成、无法保证迁移过程数据的一致性。如果停机迁移又会对业务产生较大的影响。
**一致性哈希**能在一定程度上减少系统扩容时的数据迁移，但是迁移数据时仍面临系统停止对外提供服务的情况。
#### 连续分片
连续分片能解决扩容期间的数据迁移问题，这种方式要求数据按照时间或连续自增主键连续存储。从而一段时间内的数据或相邻主键的数据会被存储在同一个分片中。当需要增加分片时，不会影响现有的分片。
* 热点数据
连续分片的主要缺点是热点问题，连续分片使得新插入的数据集中在同一个分片上，而往往新插入的数据读写频率较高，因此，读写操作都会集中在最新的分片上，从而无法体现数据分片的优势。

### 同步
分库分表后自然而然出现了多个数据库，那么怎么保证多个数据库之间的数据一致性呢？
MySQL有一个master-slave功能，可以实现主库与从库数据的自动同步，是基于**binlog复制**来实现的。在主库进行的写操作，会形成binlog，然后Mysql会把这个日志异步的同步到从库上，从库再自动执行一遍这个binlog，那么数据就跟主库一致了。

### 路由
项目中常有这样的需求：
* 让写请求访问Master实例，让读请求访问Slave实例，即实现读写分离；
* 让同一用户的请求打到同一个实例上，即根据userId进行hash。

这样的请求路由转发一般有两种实现方式：
* 编码
编码的时候根据需求将读写打到两个数据库实例上。
这样的缺点是硬编码容易造成后续维护困难。
* 中间件
将请求改成发往一个数据库代理，由代理服务器实现请求路由。

### CQRS（Command Query Responsibility Segregation，命令（增删改）和查询的责任分离）
CQRS 强调 Query（读） 和 Command（写）分离，Command 主要做业务逻辑的执行，Query来负责数据查询和展示。同时这两种操作是基于不同的数据源，甚至允许一个是数据库、另一个是NoSQL，NoSQL可以直接按照领域模型进行存储，而并不是按照数据模型存储，这样查询出来后不需要转换立即展示，效率更高。


### 分库分表的常见问题
* 跨库操作
在关系型数据库中，多张表之间往往存在关联，我们在开发过程中需要使用 `join` 进行多表连接。但是当我们使用了分库分表模式后，由于数据库厂商出于安全考虑，不允许跨库 `join` 操作，从而如果需要连接的两张表被分到不同的库中后，就无法使用 SQL 提供的 `join` 关键字来实现表连接。因此，当我们使用分库分表时，需要根据具体的业务场景，合理地设置分片策略、设置分片字段。
> 可以在业务系统层面，通过多次 SQL 查询，完成数据的组装和拼接。这一方面会增加业务系统的复杂度，另一方面会增加业务系统的负载。
* 分布式事务
我们知道，数据库提供了事务的功能，以保证数据一致性。然而，这种事务只是针对单数据库而言的，数据库厂商并未提供跨库事务。因此，当我们使用了分库分表之后，就需要我们在业务系统层面实现分布式事务。

### 方案比较
- | 分库 | 分表 | 读写分离
- | - | - | -
Cobar | 
MyCat | 
ShardingJDBC | 



