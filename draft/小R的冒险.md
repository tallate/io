---
title: 小R的冒险（10%）
date: 2019-07-01 23:09:45
tags:
---

## 一、小R的冒险的起始

## 二、小R的历程

### 虚拟IP（VIP）
虚拟ip即为一个网卡设置多个ip，相当于别名。
#### 有什么作用？
1. 布网需要
1. 简单的负载均衡
实现高可用性HA（High Availability）的最有效方法就是实时检测和自动切换：
    * **心跳**（实时检测），采用定时发送一个数据包，如果机器多长时间没响应，就认为是发生故障，自动切换到热备的机器上去。
    * **虚拟IP**（自动切换），虚拟IP就是一个未分配给真实主机的IP，也就是说对外提供数据库服务器的主机除了有一个真实IP外还有一个虚IP，使用这两个IP中的 任意一个都可以连接到这台主机，所有项目中数据库链接一项配置的都是这个虚IP，当服务器发生故障无法对外提供服务时，动态将这个虚IP切换到备用主机。
1. 多ip访问测试
1. 特定软件对多ip的需要
#### 相关命令
```bash
# 设置静态ip
ifconfig eth0 192.168.0.105 netmask 255.255.255.0 up
# 设置虚拟ip
ifconfig eth0:1 192.168.0.107 netmask 255.255.0.0
ifconfig eth0:1 down
# ping一下目标ip
ping 192.168.0.107
# 查看arp缓存表
arp -a
```
> 在设置ip别名时，如果增加的是和局域网同一网段的ip（如192.168.6.100），那么除了本机外局域网内其他机器都可以ping通这个ip。如果增加的是奇形怪状的ip，那么就只有本机可以ping通而已，后者主要用于本机测试需要。
> 重启后之前设置的vip会失效，如果需要长时间使用ip别名，最好将别名信息保存起来，一般方法有两个：1.将设置vip的命令保存到/etc/rc.local(作用相当于开机自动执行命令);2.手动在/etc/sysconfig/network-scripts下编写ip别名的网卡配置文件，以下是其中部分需要特别注意的，其他部分直接从原来网卡的配置中粘过来即可：
```bash
# 3Com Corporation 3c905B 100BaseTX [Cyclone]    //硬件型号，忽略不计
DEVICE=eth0:0                 //虚拟网络接口，随意    
ONBOOT=yes                    //系统启动时激活
BOOTPROTO=static             //使用静态ip地址                
IPADDR=192.168.6.100          //该虚拟网络接口的ip别名，随意
NETMASK=255.255.255.0         //子网掩码，对应ip别名
GATEWAY=192.168.6.1           //网关，对应ip别名
HWADDR=00:10:5A:5E:B1:E4      //网卡MAC地址，无需更改                   
USERCTL=no                    //是否给予非root用户设备管理权限
```
#### 实现原理
**其实现原理主要是靠TCP/IP的ARP协议**。
因为ip地址只是一个逻辑地址，在以太网中MAC地址才是真正用来进行数据传输的物理地址，每台主机中都有一个ARP高速缓存，存储同一个网络内的IP地址与MAC地址的对应关系，以太网中的主机发送数据时会先从这个缓存中查询目标IP对应的MAC地址，会向这个MAC地址发送数据。操作系统会自动维护这个缓存。这就是整个实现的关键。
下边就是我电脑上的arp缓存的内容。
```bash
(192.168.1.219) at 00:21:5A:DB:68:E8 [ether] on bond0
(192.168.1.217) at 00:21:5A:DB:68:E8 [ether] on bond0
(192.168.1.218) at 00:21:5A:DB:7F:C2 [ether] on bond0
```
192.168.1.217、192.168.1.218是两台真实的电脑，
192.168.1.217为对外提供数据库服务的主机。
192.168.1.218为热备的机器。
192.168.1.219为虚IP。
其中，219、217的MAC地址是相同的。
再看看217宕机后的arp缓存
```bash
(192.168.1.219) at 00:21:5A:DB:7F:C2 [ether] on bond0
(192.168.1.217) at 00:21:5A:DB:68:E8 [ether] on bond0
(192.168.1.218) at 00:21:5A:DB:7F:C2 [ether] on bond0 
```
这就是奥妙所在。当218 发现217宕机后会向网络发送一个ARP数据包，告诉所有主机192.168.1.219这个IP对应的MAC地址是00:21:5A:DB:7F:C2，这样所有发送到219的数据包都会发送到mac地址为00:21:5A:DB:7F:C2的机器，也就是218的机器。
